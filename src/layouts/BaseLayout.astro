---
import '../styles/global.css';
import SEO from '../components/SEO.astro';
import StructuredData from '../components/StructuredData.astro';
import { type Locale, getAlternateLocale } from '../i18n/utils';

interface Props {
	locale: Locale;
	title: string;
	description?: string;
	type?: 'website' | 'article';
	image?: string;
	noindex?: boolean;
	canonical?: string;
}

const {
	locale,
	title,
	description = 'Automatisk synkronisering mellom Quick3 ERP og WooCommerce',
	type = 'website',
	image,
	noindex = false,
	canonical
} = Astro.props;

const alternateLocale = getAlternateLocale(locale);
const currentPath = Astro.url.pathname;
const alternatePath = currentPath.replace(`/${locale}`, `/${alternateLocale}`);
const site = Astro.site || 'https://quick3-for-woocommerce.no';
---

<!doctype html>
<html lang={locale}>
	<head>
		<!-- Google Consent Mode v2 - Must load BEFORE GTM -->
		<script is:inline>
			// Initialize dataLayer before GTM loads
			window.dataLayer = window.dataLayer || [];
			function gtag(){dataLayer.push(arguments);}

			// Set default consent states (denied until user consents)
			gtag('consent', 'default', {
				'ad_storage': 'denied',
				'ad_user_data': 'denied',
				'ad_personalization': 'denied',
				'analytics_storage': 'denied',
				'functionality_storage': 'granted', // Required for site functionality
				'personalization_storage': 'denied',
				'security_storage': 'granted', // Required for security
				'wait_for_update': 500 // Wait for consent banner
			});

			// Enable URL passthrough for conversion tracking even when cookies denied
			gtag('set', 'url_passthrough', true);

			// Enable conversion modeling and behavioral modeling
			gtag('set', 'ads_data_redaction', true);
		</script>

		<!-- Google Tag Manager -->
		<script is:inline>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
		new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
		j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
		'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
		})(window,document,'script','dataLayer','GTM-T7HVFHS4');</script>
		<!-- End Google Tag Manager -->

		<!-- Klaro Cookie Consent -->
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/klaro@0.7.18/dist/klaro.min.css" />
		<script defer data-config="klaroConfig" src="https://cdn.jsdelivr.net/npm/klaro@0.7.18/dist/klaro-no-css.min.js"></script>

		<!-- Custom Klaro Styling - Match site's indigo theme -->
		<style>
			.klaro .cookie-notice,
			.klaro .cookie-modal {
				--primary-color: #4f46e5;
				--primary-hover: #4338ca;
			}

			.klaro .cookie-notice,
			.klaro .cookie-modal .cm-modal {
				border-radius: 0.75rem;
				box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
			}

			.klaro .cn-buttons button.cm-btn.cm-btn-success,
			.klaro .cookie-modal .cm-btn.cm-btn-success {
				background-color: var(--primary-color);
				border-color: var(--primary-color);
			}

			.klaro .cn-buttons button.cm-btn.cm-btn-success:hover,
			.klaro .cookie-modal .cm-btn.cm-btn-success:hover {
				background-color: var(--primary-hover);
				border-color: var(--primary-hover);
			}

			.klaro .cookie-modal .cm-btn.cm-btn-info {
				color: var(--primary-color);
				border-color: var(--primary-color);
			}

			.klaro .cookie-modal .cm-btn.cm-btn-info:hover {
				background-color: #eef2ff;
			}

			.klaro .cookie-modal .cm-switch input:checked+.cm-slider {
				background-color: var(--primary-color);
			}

			.klaro .cookie-modal .cm-switch .cm-slider:before {
				background-color: white;
			}

			.klaro .cookie-notice {
				max-width: 24rem;
			}

			@media (max-width: 640px) {
				.klaro .cookie-notice {
					max-width: 100%;
					margin: 0 1rem 1rem 1rem;
				}
			}
		</style>

		<!-- Set locale for Klaro -->
		<script is:inline set:html={`window.__LOCALE__ = ${JSON.stringify(locale)};`}></script>

		<!-- Klaro Configuration -->
		<script define:inline>
			window.klaroConfig = {
				version: 1,
				elementID: 'klaro',
				styling: {
					theme: ['light', 'wide']
				},
				noAutoLoad: false,
				htmlTexts: true,
				embedded: false,
				groupByPurpose: true,
				storageMethod: 'cookie',
				cookieName: 'klaro',
				cookieExpiresAfterDays: 365,
				default: false,
				mustConsent: true,
				acceptAll: true,
				hideDeclineAll: false,
				hideLearnMore: false,
				noticeAsModal: true,

				// Use server-side locale from Astro props
				lang: window.__LOCALE__,

				translations: {
					no: {
						consentModal: {
							title: 'Informasjonskapsler og personvern',
							description: 'Vi bruker informasjonskapsler og lignende teknologier for å forbedre din opplevelse, analysere nettstedstrafikk, og vise personlig tilpassede annonser. Du kan velge hvilke kategorier du vil godta.',
						},
						consentNotice: {
							changeDescription: 'Det har vært endringer siden ditt siste besøk. Vennligst oppdater ditt samtykke.',
							description: 'Vi bruker informasjonskapsler og lignende teknologier for å forbedre din opplevelse, analysere nettstedstrafikk, og vise personlig tilpassede annonser.',
							learnMore: 'Les mer',
						},
						purposeItem: {
							service: 'tjeneste',
							services: 'tjenester',
						},
						purposes: {
							analytics: 'Analyse',
							marketing: 'Markedsføring og annonsering',
						},
						ok: 'Godta alle',
						save: 'Lagre valg',
						decline: 'Avslå alle',
						close: 'Lukk',
						acceptAll: 'Godta alle',
						acceptSelected: 'Godta valgte',
					},
					en: {
						consentModal: {
							title: 'Cookies and Privacy',
							description: 'We use cookies and similar technologies to improve your experience, analyze website traffic, and display personalized advertisements. You can choose which categories to accept.',
						},
						consentNotice: {
							changeDescription: 'There have been changes since your last visit. Please update your consent.',
							description: 'We use cookies and similar technologies to improve your experience, analyze website traffic, and display personalized advertisements.',
							learnMore: 'Learn more',
						},
						purposeItem: {
							service: 'service',
							services: 'services',
						},
						purposes: {
							analytics: 'Analytics',
							marketing: 'Marketing and Advertising',
						},
						ok: 'Accept all',
						save: 'Save choices',
						decline: 'Decline all',
						close: 'Close',
						acceptAll: 'Accept all',
						acceptSelected: 'Accept selected',
					}
				},

				// Services configuration
				services: [
					{
						name: 'google-analytics',
						title: 'Google Analytics',
						description: {
							no: 'Hjelper oss forstå hvordan besøkende bruker nettstedet vårt.',
							en: 'Helps us understand how visitors use our website.',
						},
						purposes: ['analytics'],
						required: false,
						optOut: false,
						default: false,
						onAccept: function() {
							// Update Google Consent Mode
							gtag('consent', 'update', {
								'analytics_storage': 'granted'
							});
						},
						onDecline: function() {
							gtag('consent', 'update', {
								'analytics_storage': 'denied'
							});
						}
					},
					{
						name: 'google-ads',
						title: 'Google Ads',
						description: {
							no: 'Brukes til å måle effektiviteten av våre annonsekampanjer og vise relevante annonser.',
							en: 'Used to measure the effectiveness of our advertising campaigns and show relevant ads.',
						},
						purposes: ['marketing'],
						required: false,
						optOut: false,
						default: false,
						onAccept: function() {
							gtag('consent', 'update', {
								'ad_storage': 'granted',
								'ad_user_data': 'granted',
								'ad_personalization': 'granted'
							});
						},
						onDecline: function() {
							gtag('consent', 'update', {
								'ad_storage': 'denied',
								'ad_user_data': 'denied',
								'ad_personalization': 'denied'
							});
						}
					},
					{
						name: 'facebook-pixel',
						title: 'Facebook Pixel',
						description: {
							no: 'Brukes til å måle og optimalisere Facebook-annonsekampanjer og bygge målgrupper for retargeting.',
							en: 'Used to measure and optimize Facebook ad campaigns and build audiences for retargeting.',
						},
						purposes: ['marketing'],
						required: false,
						optOut: false,
						default: false,
						onAccept: function() {
							// Facebook Pixel will be loaded via GTM
							// TODO: Add Facebook Pixel tag in GTM with trigger based on this consent
							console.log('Facebook Pixel consent granted');
						},
						onDecline: function() {
							console.log('Facebook Pixel consent denied');
						}
					},
					{
						name: 'linkedin-insight',
						title: 'LinkedIn Insight Tag',
						description: {
							no: 'Brukes til å spore konverteringer fra LinkedIn-annonser og bygge målgrupper for retargeting.',
							en: 'Used to track conversions from LinkedIn ads and build audiences for retargeting.',
						},
						purposes: ['marketing'],
						required: false,
						optOut: false,
						default: false,
						onAccept: function() {
							// LinkedIn tag will be loaded via GTM
							// TODO: Add LinkedIn Insight Tag in GTM with trigger based on this consent
							console.log('LinkedIn Insight Tag consent granted');
						},
						onDecline: function() {
							console.log('LinkedIn Insight Tag consent denied');
						}
					}
				],
			};
		</script>

		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />

		<!-- Favicons -->
		<link rel="icon" type="image/png" sizes="32x32" href="/favicon.png?v=1" />
		<link rel="icon" type="image/png" sizes="512x512" href="/favicon-large.png?v=1" />
		<link rel="apple-touch-icon" href="/favicon-large.png?v=1" />

		<!-- Hreflang tags for language alternates -->
		<link rel="alternate" hreflang={locale} href={`${site}${currentPath}`} />
		<link rel="alternate" hreflang={alternateLocale} href={`${site}${alternatePath}`} />
		<link rel="alternate" hreflang="x-default" href={`${site}/no`} />

		<!-- SEO Component -->
		<SEO
			title={title}
			description={description}
			locale={locale}
			type={type}
			image={image}
			noindex={noindex}
			canonical={canonical}
		/>

		<!-- Structured Data -->
		<StructuredData type="organization" />
		<StructuredData type="software" />

		<meta name="generator" content={Astro.generator} />
	</head>
	<body class="min-h-screen bg-white text-gray-900">
		<!-- Google Tag Manager (noscript) -->
		<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-T7HVFHS4"
		height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
		<!-- End Google Tag Manager (noscript) -->

		<slot />
	</body>
</html>
