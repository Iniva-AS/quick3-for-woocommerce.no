---
import '../styles/global.css';
import SEO from '../components/SEO.astro';
import StructuredData from '../components/StructuredData.astro';
import { type Locale, getAlternateLocale } from '../i18n/utils';

interface Props {
	locale: Locale;
	title: string;
	description?: string;
	type?: 'website' | 'article';
	image?: string;
	noindex?: boolean;
	canonical?: string;
}

const {
	locale,
	title,
	description = 'Automatisk synkronisering mellom Quick3 ERP og WooCommerce',
	type = 'website',
	image,
	noindex = false,
	canonical
} = Astro.props;

const alternateLocale = getAlternateLocale(locale);
const currentPath = Astro.url.pathname;
const alternatePath = currentPath.replace(`/${locale}`, `/${alternateLocale}`);
const site = Astro.site || 'https://quick3-for-woocommerce.no';
---

<!doctype html>
<html lang={locale}>
	<head>
		<!--
		═══════════════════════════════════════════════════════════════
		COOKIE CONSENT & TRACKING IMPLEMENTATION
		═══════════════════════════════════════════════════════════════

		This site uses:
		1. Google Consent Mode v2 - GDPR-compliant tracking
		2. Klaro - Cookie consent management UI
		3. Google Tag Manager (GTM) - Tag management

		CURRENT STATUS:
		✅ Consent Mode v2 configured
		✅ Klaro consent UI configured
		✅ GTM container active (GTM-T7HVFHS4)
		✅ Conversion tracking events implemented (plan_click, contact_form_submit)
		⚠️  Tags need to be configured in GTM (see below)

		═══════════════════════════════════════════════════════════════
		CONVERSION EVENTS BEING TRACKED
		═══════════════════════════════════════════════════════════════

		1. PLAN CLICK EVENT (event: 'plan_click')
		   Fires when: User clicks any pricing plan button
		   Data sent to dataLayer:
		   - plan_name: "Free" | "Business" | "Enterprise"
		   - plan_id: "tier-free" | "tier-business" | "tier-enterprise"
		   - plan_price: "$0" | "$149.99" | "$449" (monthly) or annually
		   - billing_cycle: "monthly" | "annually"
		   - checkout_url: Full Freemius checkout URL
		   - event_category: "Pricing"
		   - event_action: "Plan Click"
		   - event_label: "Business - monthly" (example)

		   Component: website/src/components/Pricing.astro
		   Use case: Track which plan is most popular, conversion funnel start

		2. CONTACT FORM SUBMIT EVENT (event: 'contact_form_submit')
		   Fires when: User successfully submits contact form (n8n confirms)
		   Data sent to dataLayer:
		   - form_type: "contact"
		   - form_name: "Contact Form"
		   - form_success: true
		   - event_category: "Contact"
		   - event_action: "Form Submit"
		   - event_label: "Contact Form Submission"

		   Component: website/src/components/ContactForm.astro
		   Use case: Track lead generation, measure ad effectiveness

		═══════════════════════════════════════════════════════════════
		HOW TO ADD TRACKING TAGS IN GTM
		═══════════════════════════════════════════════════════════════

		1. GOOGLE ANALYTICS 4
		   - Go to GTM > Tags > New
		   - Tag Type: Google Analytics: GA4 Configuration
		   - Add your GA4 Measurement ID
		   - Triggering: All Pages (GTM respects Consent Mode automatically)
		   - Save & Publish

		2. GOOGLE ADS CONVERSION TRACKING - PLAN CLICKS

		   STEP A: Create Custom Event Trigger for Plan Clicks
		   - Go to GTM > Triggers > New
		   - Trigger Type: Custom Event
		   - Event name: plan_click
		   - Save as "Plan Click Event"

		   STEP B: Create Google Ads Conversion Tag for Plan Clicks
		   - Go to GTM > Tags > New
		   - Tag Type: Google Ads Conversion Tracking
		   - Add your Google Ads Conversion ID (format: AW-XXXXXXXXX)
		   - Add your Conversion Label (get from Google Ads > Conversions)
		   - Conversion Value: Use variable {{plan_price}} (optional)
		   - Triggering: Select "Plan Click Event" trigger created above
		   - Save & Publish

		   OPTIONAL: Create Data Layer Variables for detailed tracking
		   - GTM > Variables > New > Data Layer Variable
		   - Variable name: "DLV - Plan Name"
		   - Data Layer Variable Name: plan_name
		   - Repeat for: plan_id, plan_price, billing_cycle
		   - Use these variables in your conversion tag for better reporting

		3. GOOGLE ADS CONVERSION TRACKING - CONTACT FORM

		   STEP A: Create Custom Event Trigger for Form Submit
		   - Go to GTM > Triggers > New
		   - Trigger Type: Custom Event
		   - Event name: contact_form_submit
		   - Save as "Contact Form Submit Event"

		   STEP B: Create Google Ads Conversion Tag for Form Submit
		   - Go to GTM > Tags > New
		   - Tag Type: Google Ads Conversion Tracking
		   - Add your Google Ads Conversion ID (format: AW-XXXXXXXXX)
		   - Add your Conversion Label (different from plan click label)
		   - Triggering: Select "Contact Form Submit Event" trigger
		   - Save & Publish

		4. FACEBOOK PIXEL (when ready)
		   - Go to GTM > Tags > New
		   - Tag Type: Custom HTML
		   - Paste Facebook Pixel base code
		   - Add your Facebook Pixel ID
		   - Create a trigger based on consent:
		     • Trigger Type: Custom Event
		     • Event name: klaro-facebook-pixel-accepted
		   - IMPORTANT: Configure this tag to fire on consent
		   - Save & Publish

		5. LINKEDIN INSIGHT TAG (when ready)
		   - Go to GTM > Tags > New
		   - Tag Type: Custom HTML
		   - Paste LinkedIn Insight Tag code
		   - Add your LinkedIn Partner ID
		   - Create a trigger based on consent:
		     • Trigger Type: Custom Event
		     • Event name: klaro-linkedin-insight-accepted
		   - IMPORTANT: Configure this tag to fire on consent
		   - Save & Publish

		═══════════════════════════════════════════════════════════════
		TESTING YOUR SETUP
		═══════════════════════════════════════════════════════════════

		STEP 1: Test Cookie Consent & Consent Mode
		1. Open site in incognito mode
		2. Open Chrome DevTools > Console
		3. You should see consent banner
		4. Accept cookies and check console for:
		   - "Facebook Pixel consent granted" (if configured)
		   - "LinkedIn Insight Tag consent granted" (if configured)

		STEP 2: Test Conversion Tracking Events (BEFORE GTM setup)
		1. Open Chrome DevTools > Console
		2. Type: window.dataLayer (should see array)
		3. Click a pricing plan button
		4. Console should show: "🎯 Plan Click Tracked: {...}"
		5. Check dataLayer: window.dataLayer
		6. You should see object with event: 'plan_click'
		7. Scroll to contact form, fill it out, submit
		8. Console should show: "📩 Contact Form Submission Tracked: {...}"
		9. Check dataLayer again - should see event: 'contact_form_submit'

		STEP 3: Test GTM Integration (AFTER GTM setup)
		1. Go to GTM > Preview mode
		2. Enter your site URL
		3. Click pricing plan button
		4. GTM Preview should show "plan_click" event fired
		5. Check that your Google Ads conversion tag fired
		6. Submit contact form
		7. GTM Preview should show "contact_form_submit" event fired
		8. Verify Google Ads conversion tag fired

		STEP 4: Test Google Consent Mode
		1. Use Google Tag Assistant Chrome Extension
		2. Visit your site
		3. Accept cookies
		4. Tag Assistant should show:
		   - Consent Mode enabled
		   - analytics_storage: granted
		   - ad_storage: granted
		5. Clear cookies, decline consent
		6. Tag Assistant should show:
		   - Consent Mode enabled
		   - analytics_storage: denied
		   - ad_storage: denied
		   - URL passthrough active (conversion modeling working)

		═══════════════════════════════════════════════════════════════
		CONSENT MODE v2 BENEFITS
		═══════════════════════════════════════════════════════════════

		Even when users DECLINE cookies, Google can still:
		- Model conversions using AI (conversion modeling)
		- Track aggregated behavior patterns
		- Optimize ad campaigns
		- All while respecting privacy and GDPR

		This is a major advantage over traditional cookie blocking!

		═══════════════════════════════════════════════════════════════
		-->

		<!-- Google Consent Mode v2 - Must load BEFORE GTM -->
		<script is:inline>
			// Initialize dataLayer before GTM loads
			window.dataLayer = window.dataLayer || [];
			function gtag(){dataLayer.push(arguments);}

			// Set default consent states (denied until user consents)
			gtag('consent', 'default', {
				'ad_storage': 'denied',
				'ad_user_data': 'denied',
				'ad_personalization': 'denied',
				'analytics_storage': 'denied',
				'functionality_storage': 'granted', // Required for site functionality
				'personalization_storage': 'denied',
				'security_storage': 'granted', // Required for security
				'wait_for_update': 500 // Wait for consent banner
			});

			// Enable URL passthrough for conversion tracking even when cookies denied
			gtag('set', 'url_passthrough', true);

			// Enable conversion modeling and behavioral modeling
			gtag('set', 'ads_data_redaction', true);
		</script>

		<!-- Google Tag Manager -->
		<script is:inline>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
		new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
		j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
		'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
		})(window,document,'script','dataLayer','GTM-T7HVFHS4');</script>
		<!-- End Google Tag Manager -->

		<!-- Klaro Cookie Consent -->
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/klaro@0.7.18/dist/klaro.min.css" />
		<script defer data-config="klaroConfig" src="https://cdn.jsdelivr.net/npm/klaro@0.7.18/dist/klaro-no-css.min.js"></script>

		<!-- Custom Klaro Styling - Match site's indigo theme -->
		<style>
			.klaro .cookie-notice,
			.klaro .cookie-modal {
				--primary-color: #4f46e5;
				--primary-hover: #4338ca;
			}

			.klaro .cookie-notice,
			.klaro .cookie-modal .cm-modal {
				border-radius: 0.75rem;
				box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
			}

			.klaro .cn-buttons button.cm-btn.cm-btn-success,
			.klaro .cookie-modal .cm-btn.cm-btn-success {
				background-color: var(--primary-color);
				border-color: var(--primary-color);
			}

			.klaro .cn-buttons button.cm-btn.cm-btn-success:hover,
			.klaro .cookie-modal .cm-btn.cm-btn-success:hover {
				background-color: var(--primary-hover);
				border-color: var(--primary-hover);
			}

			.klaro .cookie-modal .cm-btn.cm-btn-info {
				color: var(--primary-color);
				border-color: var(--primary-color);
			}

			.klaro .cookie-modal .cm-btn.cm-btn-info:hover {
				background-color: #eef2ff;
			}

			.klaro .cookie-modal .cm-switch input:checked+.cm-slider {
				background-color: var(--primary-color);
			}

			.klaro .cookie-modal .cm-switch .cm-slider:before {
				background-color: white;
			}

			.klaro .cookie-notice {
				max-width: 24rem;
			}

			@media (max-width: 640px) {
				.klaro .cookie-notice {
					max-width: 100%;
					margin: 0 1rem 1rem 1rem;
				}
			}
		</style>

		<!-- Set locale for Klaro -->
		<script is:inline set:html={`window.__LOCALE__ = ${JSON.stringify(locale)};`}></script>

		<!-- Klaro Configuration -->
		<script define:inline>
			window.klaroConfig = {
				version: 1,
				elementID: 'klaro',
				styling: {
					theme: ['light', 'wide']
				},
				noAutoLoad: false,
				htmlTexts: true,
				embedded: false,
				groupByPurpose: true,
				storageMethod: 'cookie',
				cookieName: 'klaro',
				cookieExpiresAfterDays: 365,
				default: false,
				mustConsent: true,
				acceptAll: true,
				hideDeclineAll: false,
				hideLearnMore: false,
				noticeAsModal: true,

				// Use server-side locale from Astro props
				lang: window.__LOCALE__,

				translations: {
					no: {
						consentModal: {
							title: 'Informasjonskapsler og personvern',
							description: 'Vi bruker informasjonskapsler og lignende teknologier for å forbedre din opplevelse, analysere nettstedstrafikk, og vise personlig tilpassede annonser. Du kan velge hvilke kategorier du vil godta.',
						},
						consentNotice: {
							changeDescription: 'Det har vært endringer siden ditt siste besøk. Vennligst oppdater ditt samtykke.',
							description: 'Vi bruker informasjonskapsler og lignende teknologier for å forbedre din opplevelse, analysere nettstedstrafikk, og vise personlig tilpassede annonser.',
							learnMore: 'Les mer',
						},
						purposeItem: {
							service: 'tjeneste',
							services: 'tjenester',
						},
						purposes: {
							analytics: 'Analyse',
							marketing: 'Markedsføring og annonsering',
						},
						ok: 'Godta alle',
						save: 'Lagre valg',
						decline: 'Avslå alle',
						close: 'Lukk',
						acceptAll: 'Godta alle',
						acceptSelected: 'Godta valgte',
					},
					en: {
						consentModal: {
							title: 'Cookies and Privacy',
							description: 'We use cookies and similar technologies to improve your experience, analyze website traffic, and display personalized advertisements. You can choose which categories to accept.',
						},
						consentNotice: {
							changeDescription: 'There have been changes since your last visit. Please update your consent.',
							description: 'We use cookies and similar technologies to improve your experience, analyze website traffic, and display personalized advertisements.',
							learnMore: 'Learn more',
						},
						purposeItem: {
							service: 'service',
							services: 'services',
						},
						purposes: {
							analytics: 'Analytics',
							marketing: 'Marketing and Advertising',
						},
						ok: 'Accept all',
						save: 'Save choices',
						decline: 'Decline all',
						close: 'Close',
						acceptAll: 'Accept all',
						acceptSelected: 'Accept selected',
					}
				},

				// Services configuration
				services: [
					{
						name: 'google-analytics',
						title: 'Google Analytics',
						description: {
							no: 'Hjelper oss forstå hvordan besøkende bruker nettstedet vårt.',
							en: 'Helps us understand how visitors use our website.',
						},
						purposes: ['analytics'],
						required: false,
						optOut: false,
						default: false,
						onAccept: function() {
							// Update Google Consent Mode
							gtag('consent', 'update', {
								'analytics_storage': 'granted'
							});
						},
						onDecline: function() {
							gtag('consent', 'update', {
								'analytics_storage': 'denied'
							});
						}
					},
					{
						name: 'google-ads',
						title: 'Google Ads',
						description: {
							no: 'Brukes til å måle effektiviteten av våre annonsekampanjer og vise relevante annonser.',
							en: 'Used to measure the effectiveness of our advertising campaigns and show relevant ads.',
						},
						purposes: ['marketing'],
						required: false,
						optOut: false,
						default: false,
						onAccept: function() {
							gtag('consent', 'update', {
								'ad_storage': 'granted',
								'ad_user_data': 'granted',
								'ad_personalization': 'granted'
							});
						},
						onDecline: function() {
							gtag('consent', 'update', {
								'ad_storage': 'denied',
								'ad_user_data': 'denied',
								'ad_personalization': 'denied'
							});
						}
					},
					{
						name: 'facebook-pixel',
						title: 'Facebook Pixel',
						description: {
							no: 'Brukes til å måle og optimalisere Facebook-annonsekampanjer og bygge målgrupper for retargeting.',
							en: 'Used to measure and optimize Facebook ad campaigns and build audiences for retargeting.',
						},
						purposes: ['marketing'],
						required: false,
						optOut: false,
						default: false,
						onAccept: function() {
							// Facebook Pixel will be loaded via GTM
							// TODO: Add Facebook Pixel tag in GTM with trigger based on this consent
							console.log('Facebook Pixel consent granted');
						},
						onDecline: function() {
							console.log('Facebook Pixel consent denied');
						}
					},
					{
						name: 'linkedin-insight',
						title: 'LinkedIn Insight Tag',
						description: {
							no: 'Brukes til å spore konverteringer fra LinkedIn-annonser og bygge målgrupper for retargeting.',
							en: 'Used to track conversions from LinkedIn ads and build audiences for retargeting.',
						},
						purposes: ['marketing'],
						required: false,
						optOut: false,
						default: false,
						onAccept: function() {
							// LinkedIn tag will be loaded via GTM
							// TODO: Add LinkedIn Insight Tag in GTM with trigger based on this consent
							console.log('LinkedIn Insight Tag consent granted');
						},
						onDecline: function() {
							console.log('LinkedIn Insight Tag consent denied');
						}
					}
				],
			};
		</script>

		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />

		<!-- Favicons -->
		<link rel="icon" type="image/png" sizes="32x32" href="/favicon.png?v=1" />
		<link rel="icon" type="image/png" sizes="512x512" href="/favicon-large.png?v=1" />
		<link rel="apple-touch-icon" href="/favicon-large.png?v=1" />

		<!-- Hreflang tags for language alternates -->
		<link rel="alternate" hreflang={locale} href={`${site}${currentPath}`} />
		<link rel="alternate" hreflang={alternateLocale} href={`${site}${alternatePath}`} />
		<link rel="alternate" hreflang="x-default" href={`${site}/no`} />

		<!-- SEO Component -->
		<SEO
			title={title}
			description={description}
			locale={locale}
			type={type}
			image={image}
			noindex={noindex}
			canonical={canonical}
		/>

		<!-- Structured Data -->
		<StructuredData type="organization" />
		<StructuredData type="software" />

		<!-- Privacy-friendly analytics by Plausible -->
		<!-- Note: Plausible doesn't use cookies requiring consent under GDPR -->
		<script is:inline async src="https://plausible.io/js/pa-bhZK9jWrxpCJ0RlV0TbnP.js"></script>
		<script is:inline>
			window.plausible=window.plausible||function(){(plausible.q=plausible.q||[]).push(arguments)},plausible.init=plausible.init||function(i){plausible.o=i||{}};
			plausible.init()
		</script>

		<meta name="generator" content={Astro.generator} />
	</head>
	<body class="min-h-screen bg-white text-gray-900">
		<!-- Google Tag Manager (noscript) -->
		<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-T7HVFHS4"
		height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
		<!-- End Google Tag Manager (noscript) -->

		<slot />
	</body>
</html>
